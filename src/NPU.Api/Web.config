<?xml version="1.0" encoding="utf-8"?>
<!-- root -->
<configuration>
    <location path="." inheritInChildApplications="false">
        <system.webServer>
            <handlers>
                <add name="aspNetCore" path="api/*" verb="*" modules="AspNetCoreModuleV2"
                     resourceType="Unspecified" />
            </handlers>
            <aspNetCore processPath="dotnet" arguments=".\NPU.Api.dll" stdoutLogEnabled="false"
                        stdoutLogFile=".\logs\stdout" hostingModel="inprocess" />

            <!-- Enable static file serving -->
            <staticContent>
                <mimeMap fileExtension=".json" mimeType="application/json" />
                <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
                <mimeMap fileExtension=".html" mimeType="text/html" />
                <mimeMap fileExtension=".css" mimeType="text/css" />
                <mimeMap fileExtension=".js" mimeType="application/javascript" />
            </staticContent>

            <!-- Rewrite rules for API, Swagger, and React routing -->
            <rewrite>
                <rules>
                    <!-- Route API requests to ASP.NET Core -->
                    <rule name="API Routes" stopProcessing="true">
                        <match url="^api/.*" />
                        <action type="None" />
                    </rule>

                    <!-- Route Swagger UI and OpenAPI JSON file -->
                    <rule name="Swagger UI and OpenAPI JSON" stopProcessing="true">
                        <match url="^swagger$" />
                        <action type="Rewrite" url="/swagger/index.html" />
                    </rule>
                    <rule name="Swagger JSON" stopProcessing="true">
                        <match url="^swagger/v1/swagger.json$" />
                        <action type="Rewrite" url="/swagger/v1/swagger.json" />
                    </rule>

                    <!-- React SPA fallback -->
                    <rule name="React Routes" stopProcessing="true">
                        <match url=".*" />
                        <conditions logicalGrouping="MatchAll">
                            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                        </conditions>
                        <action type="Rewrite" url="/index.html" />
                    </rule>
                </rules>
            </rewrite>
        </system.webServer>
    </location>
</configuration>
